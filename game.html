<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>YYSMART | FlashGame</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f8;
            overflow: hidden;
        }

        #unity-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #loading-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f8;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* åŠ è½½æ å®¹å™¨ */
        #unity-loading-bar {
            width: 60%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        #unity-logo {
            width: 90px;
            height: 90px;
            background: url('TemplateData/unity-logo-light.png') center/contain no-repeat;
            margin-bottom: 20px;
            transform: scaleX(-1);
        }

        /* ========== PCç«¯æ¨ªç‰ˆè¿›åº¦æ¡ï¼ˆé»˜è®¤ï¼‰ ========== */
        #unity-progress-bar-empty {
            width: 100%;
            height: 14px;
            border: 1px solid #eee;
            border-radius: 7px;
            overflow: hidden;
            background-color: #f8f8f8;
            position: relative;
        }

        #unity-progress-bar-full {
            height: 100%;
            background-color: #ff7f24;
            width: 0%;
            transition: width 0.2s ease;
            position: absolute;
            left: 0;
            top: 0;
        }

        /* ========== ç§»åŠ¨ç«¯ç«–ç‰ˆè¿›åº¦æ¡ ========== */
        /* 1. çˆ¶å®¹å™¨ï¼šå¼ºåˆ¶logoå±…å·¦ã€è¿›åº¦æ¡å±…å³ï¼Œæ•´ä½“æ°´å¹³+å‚ç›´å±…ä¸­ */
        #unity-loading-bar.mobile-progress {
            display: flex;
            flex-direction: row; /* æ¨ªå‘æ’åˆ—ï¼ˆå·¦â†’å³ï¼‰ */
            align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
            justify-content: space-between; /* logoå·¦ã€è¿›åº¦æ¡å³ï¼ˆæˆ–ç”¨gapæ§åˆ¶é—´è·ï¼‰ */
            gap: 10px; /* logoå’Œè¿›åº¦æ¡çš„å·¦å³é—´è· */
            /* ç¡®ä¿çˆ¶å®¹å™¨å è¶³å¤Ÿå®½åº¦ï¼Œè®©å…ƒç´ èƒ½å·¦å³æ’åˆ— */
            width: 80%; /* é€‚é…é¡µé¢å®½åº¦ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ */
            height: 250px;
            max-width: 100px;
            /* é¡µé¢ä¸­æ•´ä½“å±…ä¸­ */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 2. Logoï¼šå–æ¶ˆæ‰€æœ‰æ—‹è½¬ï¼Œæ¢å¤æ­£å¸¸æ¨ªå‘æ˜¾ç¤º */
        #unity-logo.mobile-progress {
            width: 60px; /* é€‚é…æ¨ªå‘å¸ƒå±€çš„å°ºå¯¸ï¼ˆå¯è°ƒæ•´ï¼‰ */
            height: 60px;
            background: url('TemplateData/unity-logo-light.png') center/contain no-repeat;
            transform: rotate(0); /* å½»åº•å–æ¶ˆæ—‹è½¬ï¼Œæ­£å¸¸æ˜¾ç¤º */
            margin: 0; /* æ¸…ç©ºmargin */
        }

        /* 3. è¿›åº¦æ¡ï¼šæ”¹ä¸ºæ¨ªå‘è¿›åº¦æ¡ï¼ˆå®½é•¿ã€é«˜çŸ­ï¼‰ */
        #unity-loading-bar.mobile-progress #unity-progress-bar-empty {
            /* æ¨ªå‘è¿›åº¦æ¡çš„å°ºå¯¸ï¼šå®½é•¿ã€é«˜çŸ­ */
            width: 20px; /* è¿›åº¦æ¡é•¿åº¦ */
            height: 200px; /* è¿›åº¦æ¡é«˜åº¦ */
            border-radius: 6px; /* åœ†è§’é€‚é…é«˜åº¦ */
            background-color: #f0f0f0; /* è¿›åº¦æ¡åº•è‰² */
            transform: rotate(180deg); /* å–æ¶ˆä»»ä½•æ—‹è½¬ */
            position: relative;
        }

        #unity-loading-bar.mobile-progress #unity-progress-bar-full {
            /* æ¨ªå‘è¿›åº¦æ¡çš„å¡«å……æ–¹å¼ï¼šä»å·¦åˆ°å³ */
            width: 100%; /* å æ»¡è¿›åº¦æ¡é«˜åº¦ */
            height: 0%; /* åˆå§‹é«˜åº¦0ï¼ŒåŠ è½½æ—¶ä»0%å¢åŠ åˆ°100% */
            background-color: #ff7f24; /* è¿›åº¦æ¡é¢œè‰² */
            border-radius: 6px; /* åœ†è§’å’Œå®¹å™¨ä¸€è‡´ */
            position: absolute;
            left: 0;
            bottom: 0; /* ä»å·¦ä¾§å¼€å§‹å¡«å…… */
            transition: height 0.2s ease; /* å®½åº¦å˜åŒ–åŠ¨ç”»ï¼ˆæ›¿ä»£ä¹‹å‰çš„heightï¼‰ */
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: block;
        }

        #unity-warning {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: red;
            color: white;
            padding: 10px;
            display: none;
            z-index: 999;
        }
    </style>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <div id="loading-cover">
            <div id="unity-loading-bar">
                <div id="unity-logo"></div> <!-- Logoç»Ÿä¸€æ—‹è½¬180Â° -->
                <div id="unity-progress-bar-empty">
                    <div id="unity-progress-bar-full"></div>
                </div>
            </div>
        </div>

        <canvas id="unity-canvas" width="auto" height="auto"></canvas>
        <div id="unity-warning"></div>
    </div>

    <script src="Build/FlashGame.loader.js"></script>
    <script>
        let unityInstance = null;
        // ================ å…³é”®ä¿®æ”¹ï¼šæ›¿æ¢åŸæœ‰ç®€å•æ£€æµ‹ï¼Œæ”¹ä¸ºå¤šç»´åº¦é¸¿è’™+ç§»åŠ¨ç«¯æ£€æµ‹ ================
        // å¤šç»´åº¦æ£€æµ‹é¸¿è’™ç³»ç»Ÿï¼ˆå«åŸç”Ÿ/å…¼å®¹å±‚ã€å¾®ä¿¡æµè§ˆå™¨ï¼‰
        function detectHarmonyOS() {
            let userAgent = '';
            try {
                userAgent = navigator.userAgent.toLowerCase();
            } catch (e) {
                console.warn('æ£€æµ‹é¸¿è’™ç³»ç»Ÿå¤±è´¥ï¼š', e);
                return false;
            }
            // æ£€æµ‹åŸç”Ÿé¸¿è’™æ ‡è¯†
            const hasHarmonyUA = /harmonyos|harmony/.test(userAgent);
            // æ£€æµ‹é¸¿è’™ä¸“å±API
            const hasHarmonyAPI = typeof window.harmonyOS !== 'undefined';
            // æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨+å®‰å“ç¯å¢ƒï¼ˆé¸¿è’™å…¼å®¹å±‚ç‰¹å¾ï¼‰
            const isWeChat = /micromessenger/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isPureAndroid = /samsung|xiaomi|redmi|vivo|oppo|meizu/.test(userAgent) && !hasHarmonyUA;

            // é¸¿è’™ç³»ç»Ÿåˆ¤æ–­ï¼šåŸç”Ÿé¸¿è’™ || å¾®ä¿¡+å®‰å“+éçº¯å®‰å“ï¼ˆé¸¿è’™å…¼å®¹å±‚ï¼‰
            return hasHarmonyUA || hasHarmonyAPI || (isWeChat && isAndroid && !isPureAndroid);
        }

        // æœ€ç»ˆç§»åŠ¨ç«¯æ£€æµ‹ï¼šåŸæœ‰ç§»åŠ¨ç«¯ + é¸¿è’™ç³»ç»Ÿï¼ˆæ— è®ºåŸç”Ÿ/å…¼å®¹å±‚ï¼‰
        const isMobileBrowser = (
            /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
            || detectHarmonyOS() // è¡¥å……é¸¿è’™ç³»ç»Ÿæ£€æµ‹
        );
        // ================ å…³é”®ä¿®æ”¹ç»“æŸ ================
        let mobileStatusStr = isMobileBrowser ? "true" : "false";
        let sendRetryCount = 0;
        const maxRetryCount = 5;

        var loadingBar = document.querySelector("#unity-loading-bar");
        var loadingLogo = document.querySelector("#unity-logo");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");

        // åˆå§‹åŒ–è¿›åº¦æ¡æ–¹å‘ï¼ˆä»…æ§åˆ¶æ¨ªç«–ï¼Œæ— æ—‹è½¬ï¼‰
        function initLoadingBar() {
            if (isMobileBrowser) {
                loadingBar.classList.add("mobile-progress");
                loadingLogo.classList.add("mobile-progress");
                console.log("ğŸ“± ç§»åŠ¨ç«¯/é¸¿è’™ç³»ç»Ÿï¼šè¿›åº¦æ¡ä¸ºç«–ç‰ˆï¼ŒLogoå·²æ­£ä½");
            } else {
                loadingBar.classList.remove("mobile-progress");
                console.log("ğŸ’» PCç«¯ï¼šè¿›åº¦æ¡ä¸ºæ¨ªç‰ˆï¼ŒLogoå·²æ­£ä½");
            }
        }

        function unityShowBanner(msg, type) {
            const warningBanner = document.querySelector("#unity-warning");
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type === 'error') {
                div.style = 'background: red; padding: 10px; color: white; margin: 5px 0;';
            } else if (type === 'warning') {
                div.style = 'background: yellow; padding: 10px; color: black; margin: 5px 0;';
                setTimeout(() => {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        function sendMobileStatusToUnity() {
            if (!unityInstance) return;
            if (sendRetryCount >= maxRetryCount) {
                unityShowBanner("æœªæ‰¾åˆ°LoginManageræˆ–ReceiveMobileStatusæ–¹æ³•", "error");
                return;
            }
            try {
                unityInstance.SendMessage("LoginManager", "ReceiveMobileStatus", mobileStatusStr);
                console.log("âœ… ç§»åŠ¨ç«¯çŠ¶æ€å‘é€æˆåŠŸ");
            } catch (e) {
                sendRetryCount++;
                console.error(`âŒ ç¬¬${sendRetryCount}æ¬¡å‘é€å¤±è´¥ï¼š`, e.message);
                setTimeout(sendMobileStatusToUnity, 1000);
            }
        }

        function unityLoaded() {
            document.querySelector("#loading-cover").style.display = "none";

        }

        var buildUrl = "Build";
        var loaderUrl = buildUrl + "/FlashGame.loader.js";
        var config = {
            dataUrl: buildUrl + "/FlashGame.data.unityweb",
            frameworkUrl: buildUrl + "/FlashGame.framework.js.unityweb",
            <!-- #if USE_WASM -->
            codeUrl: buildUrl + "/FlashGame.wasm.unityweb",
            <!-- #endif -->
            <!-- #if MEMORY_FILENAME-- >
            memoryUrl: buildUrl + "/",
            <!-- #endif -->
            <!-- #if SYMBOLS_FILENAME-- >
            symbolsUrl: buildUrl + "/",
            <!-- #endif -->
            streamingAssetsUrl: "StreamingAssets",
            companyName: "NanJingYaoYu",
            productName: "FlashGame",
            productVersion: "3.0.0",
            showBanner: unityShowBanner,
            };

        // å…ˆåˆå§‹åŒ–åŠ è½½æ ï¼ˆLogoæ­£ä½+è¿›åº¦æ¡æ¨ªç«–ï¼‰
        initLoadingBar();

        if (isMobileBrowser) {
            var meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no';
            document.head.appendChild(meta);
        }

        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(document.querySelector("#unity-canvas"), config, (progress) => {
                if (isMobileBrowser) {
                    // ç§»åŠ¨ç«¯ç«–æ¡ï¼šé«˜åº¦ä»0â†’100%ï¼ˆä»ä¸‹å¾€ä¸Šå¡«å……ï¼‰
                    progressBarFull.style.height = 100 * progress + "%";
                } else {
                    // PCç«¯æ¨ªæ¡ï¼šå®½åº¦ä»0â†’100%ï¼ˆä»å·¦å¾€å³å¡«å……ï¼‰
                    progressBarFull.style.width = 100 * progress + "%";
                }
            }).then((instance) => {
                unityInstance = instance;
                unityLoaded();
            }).catch((message) => {
                unityShowBanner(message, 'error');
                console.error("âŒ Unityå®ä¾‹åˆ›å»ºå¤±è´¥:", message);
            });
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
